<!DOCTYPE html>
<html lang="en">
    <meta charset = "UTF-8" name = "viewport" content = "width = device-width, initial-scale = 1.0">

    <head>
        <title>Constrained Dynamics</title>
        <style>
            body {
                font-family: "Cascadia Code";
                font-size: 15px;
            };
            .button {
                background-color: #606060;
                border: none;
                color: white;
                padding: 10px 32px;
                font-size: 16px;
                margin: 4px 2px;
                cursor: pointer;
            };
        </style>
    </head>

    <body>
        <button class = "button" type = "button" onclick = "restart()">Restart</button>
        <button class = "button" type = "button" onclick = "run()">Run</button>
        <button class = "button" type = "button" onclick = "step()">Step</button>

        <br> PBD Acceleration: <span id = "pbd-acceleration">0.000</span>
        <br> Ana Acceleration: <span id = "ana-acceleration">0.000</span>

        <br>
        <canvas id = "canvas"></canvas>
        <script src = "../utility/math/vector.js"></script>
        <script src = "../utility/canvas.js"></script>
        <script src = "../utility/math/shape/circle.js"></script>
        <script src = "../utility/physics/component/mass.js"></script>
        <script src = "../utility/physics/rigid-body/disk.js"></script>
        <script src = "../utility/physics/field/clear-acceleration.js"></script>
        <script src = "../utility/physics/field/proportional-acceleration.js"></script>
        <script src = "../utility/physics/constrain/pendulum.js"></script>
        <script>
            let min_simulation_size = 2.0;
            let canvas_size = Vector2.from_components(window.innerWidth - 20, window.innerHeight - 100);
            let canvas_to_world_scale = min_simulation_size / Math.min(canvas_size.x, canvas_size.y);
            let world_size = canvas_size.clone().scale(canvas_to_world_scale);

            let plotting_scale = Plotting_Scale.from(world_size, canvas_size, 1.0 / canvas_to_world_scale);
            let canvas = Canvas.from("canvas", plotting_scale);

            let world = {
                paused: true,

                num_steps: 1000,
                planck_time: 1.0 / 60.0,
                subjects: [],

                clear: null,
                gravity: null,
                pbd_pendulum: null,
                ana_pendulum: null,

                update: function () {
                    if (world.paused) return;

                    let delta_time = world.planck_time / world.num_steps;
                    let pbd_acceleration = 0.0;
                    let ana_acceleration = 0.0;
                    let pbd_disk = world.subjects[0];
                    let ana_disk = world.subjects[1];
                    for (let i = 0; i < world.num_steps; i++) {
                        world.clear.apply();
                        world.gravity.apply();
                        pbd_acceleration = world.pbd_pendulum.act_on(pbd_disk, delta_time);
                        ana_acceleration = world.ana_pendulum.act_on(ana_disk, delta_time);
                    }

                    document.getElementById("pbd-acceleration").innerHTML = pbd_acceleration.toFixed(3);
                    document.getElementById("ana-acceleration").innerHTML = ana_acceleration.toFixed(3);
                },

                render: function () {
                    canvas.clear();
                    canvas.render_wireframe_circle(world.pbd_pendulum.constrain, 0.01, "#000000");
                    canvas.render_wireframe_circle(world.ana_pendulum.constrain, 0.01, "#000000");
                    canvas.render_circle(world.subjects[0].body, "#FFFF00");
                    canvas.render_circle(world.subjects[1].body, "#00FFFF");
                },
            };

            function restart()
            {
                world.paused = true;

                world.clear = new Clear_Acceleration_Field();
                world.gravity = Proportional_Acceleration_Field.from(Vector2.from_components(0.0, -10.0));

                let constrain_circle = Circle.from(Vector2.from_components(world_size.x / 2.0, world_size.y / 2.0), min_simulation_size * 0.4);
                world.pbd_pendulum = Pendulum.from(constrain_circle, Pendulum_Simulation_Mode.position_based_dynamic);
                world.ana_pendulum = Pendulum.from(constrain_circle, Pendulum_Simulation_Mode.analytic);

                let body_circle = constrain_circle.clone();
                body_circle.center.x += body_circle.radius;
                body_circle.set_radius(0.1);
                let velocity = new Vector2();
                let disk0 = Disk.from(body_circle, 0.0, velocity, 0.0);
                let disk1 = Disk.from(body_circle, 0.0, velocity, 0.0);
                world.subjects.push(disk0);
                world.subjects.push(disk1);
                world.clear.subjects.push(disk0);
                world.clear.subjects.push(disk1);
                world.gravity.subjects.push(disk0);
                world.gravity.subjects.push(disk1);

                document.getElementById("pbd-acceleration").innerHTML = 0.0.toFixed(3);
                document.getElementById("ana-acceleration").innerHTML = 0.0.toFixed(3);
            }

            function run()
            {
                world.paused = false;
            }

            function step()
            {
                world.paused = false;
                world.update();
                world.paused = true;
            }

            function mainloop()
            {
                world.update();
                world.render();

                requestAnimationFrame(mainloop);
            }

            restart();
            mainloop();
        </script>
    </body>
</html>

