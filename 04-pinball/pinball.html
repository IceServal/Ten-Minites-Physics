<!DOCTYPE html>
<html lang="en">
    <meta charset = "UTF-8" name = "viewport" content = "width = device-width, initial-scale = 1.0">

    <head>
        <title>Pinball</title>
        <style>
            body {
                font-family: "Cascadia Code";
                font-size: 15px;
            };
            .button {
                background-color: #606060;
                border: none;
                color: white;
                padding: 10px 32px;
                font-size: 16px;
                margin: 4px 2px;
                cursor: pointer;
            };
        </style>
    </head>

    <body>
        <button type = "button" id = "button-restart" onclick = "restart()" class = "button">Restart</button>
        <button type = "button" id = "button-run" onclick = "pause_or_resume()" class = "button">Run</button>
        Score <span id = "score">0</span>

        <br>

        <canvas id = "canvas"></canvas>
        <script src = "../utility/math/vector.js"></script>
        <script src = "../utility/math/line.js"></script>
        <script src = "../utility/canvas.js"></script>
        <script src = "../utility/math/shape/circle.js"></script>
        <script src = "../utility/math/shape/rod.js"></script>
        <script src = "../utility/physics/component/mass.js"></script>
        <script src = "../utility/physics/rigid-body/disk.js"></script>
        <script src = "../utility/physics/rigid-body/capsule.js"></script>
        <script src = "../utility/physics/field/clear-acceleration.js"></script>
        <script src = "../utility/physics/field/proportional-acceleration.js"></script>
        <script src = "../utility/physics/constrain/free-movement.js"></script>
        <script src = "../utility/physics/constrain/static-collision.js"></script>
        <script src = "../utility/physics/constrain/dynamic-collision.js"></script>
        <script src = "./flipper.js"></script>
        <script>
            let canvas_size = Vector2.from_components(window.innerWidth - 20, window.innerHeight - 100);
            let canvas_to_world_scale = 1.7 / canvas_size.y;
            let world_size = canvas_size.clone().scale(canvas_to_world_scale);

            let plotting_scale = Plotting_Scale.from(world_size, canvas_size, 1.0 / canvas_to_world_scale, false);
            let canvas = Canvas.from("canvas", plotting_scale);

            let board = {
                score: 0,
            };

            let world = {
                paused: false,

                planck_time: 1.0 / 60.0,
                subjects: [],

                clear: null,
                gravity: null,
                free_movement: null,
                static_collision: null,
                dynamic_collision: null,

                flipper_system: null,

                update: function () {
                    if (world.paused) return;

                    world.clear.apply();
                    world.gravity.apply();
                    world.free_movement.apply(world.planck_time);
                    world.static_collision.apply();
                    world.dynamic_collision.apply();

                    world.flipper_system.apply(world.planck_time);

                    document.getElementById("score").innerHTML = board.score.toString();
                },

                render: function () {
                    canvas.clear();
                    for (let i = 0; i < world.subjects.length; i++) {
                        canvas.render_circle(world.subjects[i].body, "#44AA99");
                    }
                    let sc = world.static_collision;
                    for (let i = 0; i < sc.static_disks.length; i++) {
                        canvas.render_circle(sc.static_disks[i].body, "#FF0000");
                    }
                    for (let i = 0; i < sc.static_capsules.length; i++) {
                        let rod = sc.static_capsules[i].body;
                        canvas.render_rod(rod, "#000000");
                    }
                    let flippers = world.flipper_system.flippers;
                    for (let i = 0; i < flippers.length; i++) {
                        let rod = flippers[i].body;
                        canvas.render_rod(rod, "#FF4477");
                    }
                },
            };

            function restart()
            {
                board.score = 0;
                document.getElementById("score").innerHTML = board.score.toString();

                world.paused = true;
                document.getElementById("button-run").innerHTML = "Run";

                world.clear = new Clear_Acceleration_Field();
                world.gravity = Proportional_Acceleration_Field.from(Vector2.from_components(0.0, -3.0)),
                world.free_movement = new Free_Movement();
                world.static_collision = new Static_Collision();
                world.dynamic_collision = new Dynamic_Collision();
                world.flipper_system = new Flipper_System();

                {
                    let radius = 0.03;
                    let positions = [
                        Vector2.from_components(0.92, 0.5),
                        Vector2.from_components(0.08, 0.5),
                    ];
                    let velocities = [
                        Vector2.from_components(-0.5, 2.5),
                        Vector2.from_components(+0.5, 2.5),
                    ];
                    world.subjects = [];
                    for (let i = 0; i < positions.length; i++) {
                        let circle = Circle.from(positions[i], radius);
                        let disk = Disk.from(circle, 1.0, velocities[i], 1.0);
                        world.subjects.push(disk);
                        world.clear.subjects.push(disk);
                        world.gravity.subjects.push(disk);
                        world.free_movement.subjects.push(disk);
                        world.static_collision.subjects.push(disk);
                        world.dynamic_collision.subjects.push(disk);
                        world.flipper_system.subjects.push(disk);
                    }
                }

                {
                    let velocity = new Vector2();
                    let offset = 0.02;
                    let points = [
                        Vector2.from_components(0.74,         0.25),
                        Vector2.from_components(1.0 - offset, 0.4),
                        Vector2.from_components(1.0 - offset, world_size.y - offset),
                        Vector2.from_components(offset,       world_size.y - offset),
                        Vector2.from_components(offset,       0.4),
                        Vector2.from_components(0.26,         0.25),
                        Vector2.from_components(0.26,         offset),
                        Vector2.from_components(0.74,         offset),
                        Vector2.from_components(0.74,         0.25),
                    ];
                    let radius = 0.01;
                    let sc = world.static_collision.static_capsules;
                    for (let i = 0; i < points.length - 1; i++) {
                        let line = Line.from_point0_point1(points[i], points[i + 1]);
                        sc.push(Capsule.from(Rod.from(line, radius), 0.0, velocity, 1.0));
                    }
                    let sd = world.static_collision.static_disks;
                    sd.push(Disk.from(Circle.from(Vector2.from_components(0.25, 0.6), 0.15), 1.0, velocity, 1.0));
                    sd.push(Disk.from(Circle.from(Vector2.from_components(0.75, 0.5), 0.10), 1.0, velocity, 1.0));
                    sd.push(Disk.from(Circle.from(Vector2.from_components(0.7,  1.0), 0.12), 1.0, velocity, 1.0));
                    sd.push(Disk.from(Circle.from(Vector2.from_components(0.2,  1.2), 0.08), 1.0, velocity, 1.0));
                }

                {
                    let radius = 0.03;
                    let length = 0.2;
                    let rest_angle = 0.5;
                    let max_rotation = 1.0;
                    let angular_velocity = 10.0;
                    let restitution = 1.0;
                    let flippers = world.flipper_system.flippers;
                    flippers.push(Flipper.from(
                        Rod.from(
                            Line.from_point0_angle_length(
                                Vector2.from_components(0.26, 0.22),
                                -rest_angle,
                                length,
                            ),
                            radius,
                        ),
                        Angle_Limits.from(-rest_angle, -rest_angle + max_rotation),
                        angular_velocity,
                        restitution,
                    ));
                    flippers.push(Flipper.from(
                        Rod.from(
                            Line.from_point0_angle_length(
                                Vector2.from_components(0.74, 0.22),
                                Math.PI + rest_angle,
                                length,
                            ),
                            radius,
                        ),
                        Angle_Limits.from(Math.PI + rest_angle - max_rotation, Math.PI + rest_angle),
                        -angular_velocity,
                        restitution,
                    ));
                }
            }

            function pause_or_resume()
            {
                world.paused = !world.paused;
                document.getElementById("button-run").innerHTML = (world.paused ? "Recover" : "Pause");
            }

            function mainloop()
            {
                world.update();
                world.render();

                requestAnimationFrame(mainloop);
            }

            restart();
            mainloop();
        </script>
    </body>
</html>

